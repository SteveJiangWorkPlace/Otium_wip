# 生产环境诊断检查清单
## 诊断日期
2026-02-28

## 诊断目标
验证文献调研功能在生产环境（Render）中的运行状态，找出问题的根本原因。

## 准备工作
1. **访问权限**：确保您有Render Dashboard访问权限
2. **数据库工具**：准备PostgreSQL客户端（pgAdmin、psql或DBeaver）
3. **前端URL**：https://otiumtrans.netlify.app
4. **后端URL**：https://otium-backend.onrender.com

## 诊断步骤

### 步骤1：检查Render后台工作器状态（任务5.1）

#### 1.1 访问Render Dashboard
- 登录 https://dashboard.render.com/
- 导航到 `otium-background-worker` 服务
- 检查服务状态应为 "Running"

#### 1.2 检查服务日志
在Render Dashboard中查看服务日志，搜索以下关键词：
- `ERROR` - 错误信息
- `Manus` - Manus API相关日志
- `background_task` - 后台任务处理日志
- `literature_research` - 文献调研相关日志
- `chat_literature_research` - 文献调研任务类型

**预期结果**：日志中应显示工作器正常运行，没有严重错误。

#### 1.3 验证环境变量
在Render Dashboard的服务设置中，检查以下环境变量：
- `ENABLE_BACKGROUND_WORKER` - 应为 `true`
- `MANUS_API_KEY` - 应正确设置且有效
- `DATABASE_TYPE` - 应为 `postgresql`
- `DATABASE_URL` - 应包含有效的PostgreSQL连接字符串

#### 1.4 检查资源使用
查看服务的资源使用情况：
- CPU使用率：应正常（非100%）
- 内存使用率：应正常（非持续增长）
- 网络流量：应有正常流量
- 错误率：应为0或很低

### 步骤2：检查数据库任务状态（任务5.2）

#### 2.1 连接到Render PostgreSQL数据库
1. 获取连接信息：Render Dashboard → PostgreSQL数据库 → Connection
2. 使用连接字符串连接到数据库

#### 2.2 查询文献调研任务状态
执行以下SQL查询：

```sql
-- 查询最近的文献调研任务
SELECT
    id,
    task_type,
    status,
    attempts,
    progress_percentage,
    current_step,
    total_steps,
    step_description,
    created_at,
    updated_at,
    result_data IS NOT NULL as has_result_data,
    error_message
FROM background_tasks
WHERE task_type LIKE '%literature%' OR task_type LIKE '%deep%'
ORDER BY created_at DESC
LIMIT 10;
```

**预期结果**：
- 应有任务记录
- 状态应为 `COMPLETED` 或 `PROCESSING`
- 对于已完成任务，`has_result_data` 应为 true

#### 2.3 检查任务结果数据
对于已完成的任务（status = 'COMPLETED'），检查result_data字段：

```sql
-- 查看任务结果数据
SELECT
    id,
    task_type,
    status,
    result_data->>'text' as result_text_preview,
    LENGTH(result_data->>'text') as result_length,
    created_at,
    updated_at
FROM background_tasks
WHERE task_type LIKE '%literature%'
    AND status = 'COMPLETED'
    AND result_data IS NOT NULL
ORDER BY created_at DESC
LIMIT 5;
```

**预期结果**：
- `result_text_preview` 应包含文献调研结果文本
- `result_length` 应大于0

#### 2.4 检查失败任务
```sql
-- 查看失败的任务
SELECT
    id,
    task_type,
    status,
    attempts,
    error_message,
    created_at,
    updated_at
FROM background_tasks
WHERE task_type LIKE '%literature%'
    AND status = 'FAILED'
ORDER BY created_at DESC
LIMIT 10;
```

### 步骤3：验证前端-后端通信（任务5.3）

#### 3.1 测试健康检查端点
```bash
# 测试后端健康端点
curl https://otium-backend.onrender.com/api/health

# 测试简单端点
curl https://otium-backend.onrender.com/api/test
```

**预期结果**：返回JSON响应，状态码200。

#### 3.2 测试任务状态端点（需任务ID）
如果有任务ID，测试：
```bash
curl https://otium-backend.onrender.com/api/tasks/1/status
```

#### 3.3 检查浏览器网络请求
1. 打开前端应用：https://otiumtrans.netlify.app
2. 启用文献调研模式，发送测试请求
3. 在浏览器开发者工具Network面板检查：
   - `POST /api/chat` 请求状态
   - `GET /api/tasks/{task_id}/status` 轮询请求

#### 3.4 验证CORS配置
检查响应头是否包含：
- `Access-Control-Allow-Origin: https://otiumtrans.netlify.app`
- `Access-Control-Allow-Headers: Authorization, Content-Type`

### 步骤4：验证提示词系统使用（任务5.4）

#### 4.1 检查Render日志中的提示词记录
在`otium-backend`服务日志中搜索：
- `使用新提示词模板系统`
- `build_literature_research_prompt`
- `提示词模板构建完成`

#### 4.2 检查代码部署状态
确保最新的代码修改已部署到生产环境：
- `prompts.py` 包含新的文献调研提示词函数
- `api_services.py` 使用新模板系统
- `main.py` 使用新模板系统
- `AIChatPanel.tsx` 已简化显示

#### 4.3 验证提示词函数
可以通过测试端点验证：
```bash
# 测试提示词构建性能
curl https://otium-backend.onrender.com/api/debug/prompt-test
```

## 常见问题诊断表

| 症状 | 可能原因 | 检查点 |
|------|----------|--------|
| 任务一直处于PENDING状态 | 后台工作器未运行 | 1. `otium-background-worker`服务状态<br>2. `ENABLE_BACKGROUND_WORKER`环境变量<br>3. 工作器日志 |
| 任务失败，Manus API错误 | MANUS_API_KEY无效 | 1. MANUS_API_KEY环境变量<br>2. Manus API密钥状态<br>3. 错误日志 |
| 数据库连接错误 | DATABASE_URL问题 | 1. 连接字符串格式<br>2. 数据库服务状态<br>3. 网络连通性 |
| 前端无法获取任务状态 | CORS配置问题 | 1. `Access-Control-Allow-Origin`头<br>2. 前端axios配置<br>3. 网络请求日志 |
| 日志中没有新模板记录 | 代码未部署 | 1. 部署状态<br>2. 代码版本<br>3. 服务重启记录 |

## 修复建议

### 立即操作
1. **重启后台工作器**：如果服务卡住或无响应
2. **重新部署**：确保最新代码生效
3. **检查环境变量**：验证API密钥和配置

### 长期改进
1. **增强监控**：添加更详细的日志记录
2. **定期健康检查**：自动化诊断
3. **错误通知**：设置报警机制

## 记录诊断结果

请记录以下信息：
- [ ] Render后台工作器状态：
- [ ] 数据库任务状态（最近10个任务）：
- [ ] 前端-后端通信测试结果：
- [ ] 提示词系统使用验证：
- [ ] 发现的问题及解决方案：

## 下一步行动
完成诊断后，根据发现的问题进行第六阶段：生产环境问题修复。