# 生产环境诊断指南
## 诊断日期
2026-02-28

## 诊断背景
根据用户报告，生产环境下文献调研功能存在问题：
1. **提示词问题**：生产环境下"完全没有用到这一套提示词" - 指的是项目中的提示词模板系统
2. **结果返回问题**：Manus API可以被调用，也在做调研，但"结果没有返回到前端"
3. **简化需求**：加载信息只需要展示"文献调研可能需要较长时间，请耐心等待..."和加载动画

## 诊断目标
验证生产环境配置，找出文献调研功能问题的根本原因。

## 诊断步骤

### 1. 检查Render后台工作器状态

#### 1.1 访问Render Dashboard
- 登录Render Dashboard (https://dashboard.render.com/)
- 导航到 `otium-background-worker` 服务
- 检查服务状态应为 "Running"
- 检查最近部署状态和日志

#### 1.2 检查服务日志
在Render Dashboard中查看服务日志，搜索以下关键词：
- `ERROR` - 错误信息
- `Manus` - Manus API相关日志
- `background_task` - 后台任务处理日志
- `literature_research` - 文献调研相关日志
- `chat_literature_research` - 文献调研任务类型

#### 1.3 验证环境变量
在Render Dashboard的服务设置中，检查以下环境变量：
- `ENABLE_BACKGROUND_WORKER` - 应为 `true`
- `MANUS_API_KEY` - 应正确设置且有效
- `GEMINI_API_KEY` - 其他API密钥
- `DATABASE_URL` - PostgreSQL连接字符串

#### 1.4 检查资源使用
查看服务的资源使用情况：
- CPU使用率
- 内存使用率
- 网络流量
- 错误率

### 2. 检查数据库任务状态

#### 2.1 连接到Render PostgreSQL数据库
使用pgAdmin、psql或任何PostgreSQL客户端连接到数据库：
- 获取连接字符串：Render Dashboard → PostgreSQL数据库 → Connection
- 使用连接信息连接到数据库

#### 2.2 查询文献调研任务状态
执行以下SQL查询：

```sql
-- 查询最近的文献调研任务
SELECT
    id,
    task_type,
    status,
    attempts,
    progress_percentage,
    current_step,
    total_steps,
    step_description,
    created_at,
    updated_at,
    result_data IS NOT NULL as has_result_data,
    error_message
FROM background_tasks
WHERE task_type LIKE '%literature%' OR task_type LIKE '%deep%'
ORDER BY created_at DESC
LIMIT 10;
```

#### 2.3 检查任务结果数据
对于已完成的任务（status = 'COMPLETED'），检查result_data字段：

```sql
-- 查看任务结果数据
SELECT
    id,
    task_type,
    status,
    result_data->>'text' as result_text_preview,
    LENGTH(result_data->>'text') as result_length,
    created_at,
    updated_at
FROM background_tasks
WHERE task_type LIKE '%literature%'
    AND status = 'COMPLETED'
    AND result_data IS NOT NULL
ORDER BY created_at DESC
LIMIT 5;
```

#### 2.4 检查失败任务
```sql
-- 查看失败的任务
SELECT
    id,
    task_type,
    status,
    attempts,
    error_message,
    created_at,
    updated_at
FROM background_tasks
WHERE task_type LIKE '%literature%'
    AND status = 'FAILED'
ORDER BY created_at DESC
LIMIT 10;
```

### 3. 验证前端-后端通信

#### 3.1 检查网络请求
使用浏览器开发者工具：
1. 打开生产环境前端应用
2. 启用文献调研模式，发送一个测试请求
3. 在Network面板检查请求：
   - `POST /api/chat` - 创建聊天请求
   - `GET /api/tasks/{task_id}/status` - 轮询任务状态

#### 3.2 检查CORS配置
验证响应头中包含正确的CORS头：
- `Access-Control-Allow-Origin` - 应包含前端域名
- `Access-Control-Allow-Headers` - 应包含必要的头

#### 3.3 测试API端点
直接测试后端API端点：

```bash
# 测试健康端点
curl https://your-render-backend.onrender.com/api/health

# 测试任务状态端点（如果有任务ID）
curl https://your-render-backend.onrender.com/api/tasks/1/status
```

#### 3.4 检查axios配置
验证前端axios配置：
- 超时设置：当前1800秒（30分钟）
- 认证头传递
- 错误处理

### 4. 验证提示词系统使用

#### 4.1 检查日志中的提示词使用
在Render日志中搜索以下关键词：
- `build_literature_research_prompt` - 新模板函数
- `使用新提示词模板系统` - 在main.py中添加的日志
- `LITERATURE_RESEARCH_TEMPLATE_VERSION` - 模板版本标识

#### 4.2 验证代码部署
确保最新的代码修改已部署到生产环境：
- `prompts.py` 包含新的文献调研提示词函数
- `api_services.py` 使用新模板系统
- `main.py` 使用新模板系统
- `AIChatPanel.tsx` 已简化显示

### 5. 完整流程测试

#### 5.1 创建测试任务
在生产环境中：
1. 启用文献调研模式
2. 发送一个简单的文献调研请求（如："请调研人工智能在教育中的应用"）
3. 观察前端显示应为简化的等待界面

#### 5.2 监控任务处理
1. 查看Render日志，确认任务被创建
2. 查看数据库，确认任务状态更新
3. 观察前端是否成功接收结果

#### 5.3 验证结果返回
任务完成后：
1. 前端应显示文献调研结果
2. 数据库中应包含完整的result_data
3. 日志中应记录任务完成信息

## 常见问题诊断

### 问题1：后台工作器未运行
**症状**：任务一直处于PENDING状态
**检查**：
- 确认`ENABLE_BACKGROUND_WORKER=true`
- 检查`otium-background-worker`服务状态
- 查看工作器日志是否有启动错误

### 问题2：MANUS_API_KEY无效
**症状**：任务处理失败，错误信息包含API密钥相关错误
**检查**：
- 验证MANUS_API_KEY环境变量
- 检查Manus API密钥是否过期或超出限额

### 问题3：数据库连接问题
**症状**：任务状态无法更新，数据库连接错误
**检查**：
- 验证DATABASE_URL连接字符串
- 检查PostgreSQL数据库是否正常运行
- 验证网络连通性

### 问题4：前端-后端通信问题
**症状**：前端无法获取任务状态或结果
**检查**：
- CORS配置是否正确
- 网络请求是否被拦截
- axios配置是否正确

### 问题5：提示词未使用新模板
**症状**：日志中没有新模板系统的记录
**检查**：
- 代码是否成功部署
- 日志中是否有`使用新提示词模板系统`记录
- `prompts.py`是否包含新函数

## 修复建议

根据诊断结果，可能的修复措施：

1. **重启后台工作器**：如果服务卡住或无响应
2. **更新环境变量**：修复无效的API密钥
3. **修复数据库连接**：更新连接字符串或修复网络配置
4. **调整CORS配置**：添加前端域名到允许列表
5. **重新部署代码**：确保最新修改已生效

## 下一步行动
完成诊断后，根据发现的问题进行相应的修复。