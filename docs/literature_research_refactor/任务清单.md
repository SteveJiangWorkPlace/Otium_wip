# 文献调研功能重构任务清单
## 项目概述
修复生产环境下文献调研功能问题，统一术语，重构提示词系统，简化前端显示。

## 任务清单
### 第一阶段：生产环境诊断
- [ ] 任务1.1: 检查Render后台工作器状态
- [ ] 任务1.2: 检查数据库任务状态
- [ ] 任务1.3: 验证前端-后端通信

### 第二阶段：术语统一重构
- [x] 任务2.1: 创建文档目录和术语统一记录
- [x] 任务2.2: 重命名后端术语（已完成）
  - [x] schemas.py: deep_research_mode → literature_research_mode
  - [x] main.py: 更新所有deep_research_mode引用
  - [x] background_task_service.py: chat_deep_research → chat_literature_research
  - [x] background_task_service.py: _process_chat_deep_research → _process_chat_literature_research
  - [x] 更新相关日志消息和注释
- [x] 任务2.3: 重命名前端术语（已完成）
  - [x] useAIChatStore.ts: deepResearchMode → literatureResearchMode
  - [x] useAIChatStore.ts: toggleDeepResearchMode → toggleLiteratureResearchMode
  - [x] useAIChatStore.ts: setDeepResearchMode → setLiteratureResearchMode
  - [x] AIChatPanel.tsx: 更新所有deepResearchMode引用
- [ ] 任务2.4: 验证术语统一
  - [x] 后端测试通过
  - [x] 前端编译无错误
  - [ ] 功能测试正常

### 第三阶段：提示词系统重构
- [x] 任务3.1: 添加文献调研提示词函数到prompts.py
- [x] 任务3.2: 更新后端提示词调用
  - [x] 更新api_services.py使用新模板
  - [x] 更新main.py使用新模板
- [x] 任务3.3: 测试提示词构建

### 第四阶段：前端加载信息简化
- [x] 任务4.1: 简化后台任务显示
  - [x] 移除复杂进度信息
  - [x] 只保留等待文字和动画
- [x] 任务4.2: 更新CSS样式（使用 shimmer/light sweep 加载样式，已移除跳点动画）
- [x] 任务4.3: 测试前端显示

### 第五阶段：生产环境诊断
- [x] 任务5.1: 检查Render后台工作器状态（提供诊断指南）- 已创建生产环境诊断脚本
- [x] 任务5.2: 检查数据库任务状态（提供SQL查询指南）- 已创建database_diagnosis.py
- [x] 任务5.3: 验证前端-后端通信（提供测试指南）- 已包含在诊断脚本中，发现API端点404错误
- [x] 任务5.4: 验证提示词系统使用（提供验证方法）- 已包含在诊断脚本中，因API不可用无法验证

### 第六阶段：生产环境问题修复
- [x] 任务6.1: 修复诊断发现的问题 - 已识别关键问题：生产环境后端API端点404错误
- [ ] 任务6.2: 确定正确的生产环境后端URL - 进行中（需要用户提供）
- [ ] 任务6.3: 验证API端点可用性
- [ ] 任务6.4: 测试完整流程

## 进度跟踪
### 当前状态
- 第二阶段（术语统一重构）：已完成
- 第三阶段（提示词系统重构）：已完成
- 第四阶段（前端加载信息简化）：已完成
- 第五阶段（生产环境诊断）：诊断工具已创建，执行发现生产环境后端API端点返回404错误
- 第六阶段（生产环境问题修复）：开始处理生产环境API不可用问题

### 最近更新
2026-02-28:
- 完成第二阶段术语统一重构。已更新后端所有文件（schemas.py, main.py, background_task_service.py）和前端所有文件（types/index.ts, store/useAIChatStore.ts, components/AIChatPanel/AIChatPanel.tsx）
- 完成第三阶段提示词系统重构：
  - 在prompts.py中添加了文献调研提示词函数
  - 更新api_services.py使用新模板系统
  - 更新main.py使用新模板系统
  - 测试提示词构建函数，验证所有功能正常工作
- 完成第四阶段前端加载信息简化：
  - 简化了后台任务显示，移除了所有复杂进度信息
  - 只保留"文献调研可能需要较长时间，请耐心等待"文字和加载动画（微光/扫光）
  - 更新了轮询回调函数，保留轮询机制但隐藏进度更新
  - 前端构建成功，无TypeScript编译错误
- 完成第五阶段生产环境诊断工具创建：
  - 创建生产环境诊断脚本`scripts/diagnose_production.py`（任务5.1）
  - 创建数据库诊断脚本`scripts/database_diagnosis.py`（任务5.2）
  - 脚本包含：后端健康状态测试、登录功能测试、文献调研任务创建测试、任务状态轮询测试、CORS配置检查、提示词系统验证
- 生产环境诊断结果（2026-02-28）：
  - **发现关键问题**：生产环境后端API端点返回404错误
  - 测试的API端点：`https://otium-backend.onrender.com/api/health` 返回404
  - 测试的API端点：`https://otium-backend.onrender.com/api/login` 返回404
  - 后端服务根路径：`https://otium-backend.onrender.com/` 也返回404
  - **诊断结论**：生产环境后端服务未运行或部署失败，导致所有API端点不可访问
  - **影响**：文献调研功能无法正常工作，因为前端无法连接到后端API

### 下一步行动
1. **立即处理生产环境问题**：
   - 登录Render Dashboard检查`otium-backend`和`otium-background-worker`服务状态
   - 查看最近部署日志，确认是否有部署错误
   - 检查服务配置和环境变量设置
   - 必要时重启或重新部署服务

2. **验证API端点配置**：
   - 确认`main.py`中正确定义了`/api/health`端点
   - 验证生产环境FastAPI应用的根路径配置
   - 检查CORS配置是否正确

3. **修复诊断发现的问题**（第六阶段）：
   - 根据Render Dashboard检查结果修复服务部署问题
   - 确保`ENABLE_BACKGROUND_WORKER: "true"`环境变量正确设置
   - 验证MANUS_API_KEY等关键环境变量
   - 测试修复后的文献调研功能

4. **完成功能测试**：
   - 运行修复后的生产环境诊断脚本验证API可用性
   - 测试文献调研完整流程，确保结果正确返回到前端
   - 验证提示词系统正常工作
