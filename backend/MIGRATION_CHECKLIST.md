# 数据库迁移检查清单

## 迁移前检查

### 环境准备
- [ ] 备份 `usage_data.json` 文件
- [ ] 记录 `ALLOWED_USERS` 环境变量值
- [ ] 确保有足够的磁盘空间
- [ ] 检查Python版本（3.8+）

### 配置检查
- [ ] `.env` 文件包含数据库配置
- [ ] `DATABASE_TYPE` 设置为 `sqlite` 或 `postgresql`
- [ ] `DATABASE_PATH` 或 `DATABASE_URL` 正确设置
- [ ] `PASSWORD_HASH_ALGORITHM` 设置为 `sha256`

### 依赖检查
- [ ] 安装数据库依赖：`pip install -r requirements.txt`
- [ ] 验证SQLAlchemy安装：`python -c "import sqlalchemy; print(sqlalchemy.__version__)"`
- [ ] 验证psycopg2安装（如使用PostgreSQL）

## 迁移执行

### 步骤1: 安装依赖
```bash
cd backend
pip install sqlalchemy psycopg2-binary alembic
```

或使用安装脚本：
```bash
python scripts/install_dependencies.py
```

### 步骤2: 运行迁移
```bash
python scripts/migrate_to_database.py
```

检查：
- [ ] 迁移脚本成功执行
- [ ] 创建了备份文件
- [ ] 生成了迁移完成标记
- [ ] 查看 `migration.log` 无错误

### 步骤3: 测试迁移
```bash
python scripts/test_migration.py
```

检查：
- [ ] 测试脚本成功执行
- [ ] 用户认证功能正常
- [ ] 密码哈希验证正常
- [ ] 使用记录功能正常

## 功能验证

### 服务器启动
```bash
uvicorn main:app --reload
```

检查：
- [ ] 服务器正常启动
- [ ] 无错误日志
- [ ] 数据库连接正常

### API测试
1. **登录功能**
   - [ ] 管理员登录：`POST /api/login`
   - [ ] 普通用户登录：`POST /api/login`
   - [ ] 错误密码测试

2. **用户信息**
   - [ ] 获取用户信息：`GET /api/user/info`
   - [ ] 验证返回信息完整

3. **文本处理**
   - [ ] 文本纠错：`POST /api/text/check`
   - [ ] 文本翻译：`POST /api/text/check`
   - [ ] 使用次数记录

4. **AI功能**
   - [ ] AI检测：`POST /api/text/detect-ai`
   - [ ] AI聊天：`POST /api/chat`

5. **管理员功能**
   - [ ] 获取所有用户：`GET /api/admin/users`
   - [ ] 更新用户：`POST /api/admin/users/update`
   - [ ] 添加用户：`POST /api/admin/users/add`

### 数据库验证
```bash
# SQLite
sqlite3 ./data/otium.db

# 检查表
.tables

# 检查数据
SELECT * FROM users;
SELECT * FROM user_usage;
```

检查：
- [ ] 表结构正确
- [ ] 数据完整迁移
- [ ] 密码已哈希
- [ ] 管理员用户存在

## 生产环境检查

### Render平台
- [ ] `DATABASE_TYPE=postgresql`
- [ ] `DATABASE_URL` 由Render提供
- [ ] 环境变量正确设置
- [ ] PostgreSQL插件已安装

### 其他平台
- [ ] 数据库连接配置正确
- [ ] 网络访问权限
- [ ] 防火墙设置
- [ ] 备份策略

## 回滚准备

### 紧急回滚步骤
1. [ ] 停止服务器
2. [ ] 运行回滚脚本：`python scripts/rollback_migration.py`
3. [ ] 恢复 `main.py` 中的 `UserLimitManager`
4. [ ] 重启服务器

### 回滚验证
- [ ] 原始文件已恢复
- [ ] 环境变量示例已生成
- [ ] 数据库备份已创建
- [ ] 功能恢复正常

## 性能监控

### 迁移后监控
- [ ] 响应时间监控
- [ ] 数据库连接数监控
- [ ] 错误率监控
- [ ] 磁盘空间监控

### 优化建议
- [ ] 添加数据库索引
- [ ] 配置连接池
- [ ] 实现查询缓存
- [ ] 定期清理历史数据

## 文档更新

### 更新文档
- [ ] 更新部署文档
- [ ] 更新API文档
- [ ] 更新故障排除指南
- [ ] 更新维护手册

### 团队通知
- [ ] 通知开发团队
- [ ] 通知运维团队
- [ ] 更新知识库
- [ ] 培训相关人员

## 最终确认

### 迁移成功标准
- [ ] 所有功能测试通过
- [ ] 性能满足要求
- [ ] 数据完整性验证
- [ ] 回滚方案验证

### 签字确认
- 开发负责人：_________________ 日期：_________
- 测试负责人：_________________ 日期：_________
- 运维负责人：_________________ 日期：_________

## 问题记录

### 遇到的问题
1. __________________________________________________
   解决方案：_________________________________________

2. __________________________________________________
   解决方案：_________________________________________

3. __________________________________________________
   解决方案：_________________________________________

### 经验总结
- __________________________________________________
- __________________________________________________
- __________________________________________________

## 后续计划

### 短期（1周内）
- [ ] 性能优化
- [ ] 监控设置
- [ ] 文档完善

### 中期（1月内）
- [ ] 备份策略实施
- [ ] 高可用配置
- [ ] 安全审计

### 长期（3月内）
- [ ] 架构优化
- [ ] 功能扩展
- [ ] 自动化运维