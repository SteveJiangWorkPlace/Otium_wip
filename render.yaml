# Render Blueprint for Otium Application
# This file defines the infrastructure for the Otium backend and database

# ============================================
# Services Configuration
# ============================================

services:
  # Otium Backend API Service
  - type: web
    name: otium-backend
    env: python
    pythonVersion: "3.11.9"
    region: oregon  # or: frankfurt, singapore, ohio, etc.
    buildCommand: pip install -r backend/requirements.txt
    startCommand: cd backend && gunicorn --bind 0.0.0.0:$PORT --workers 4 --worker-class uvicorn.workers.UvicornWorker --timeout 120 main:app
    healthCheckPath: /api/health
    envVars:
      # ==================== 应用配置 ====================
      - key: ENVIRONMENT
        value: production
      - key: DEBUG
        value: false

      # ==================== Render 自动配置 ====================
      - key: RENDER
        value: true
      - fromService:
          type: postgres
          name: otium-database
          property: connectionString

      # ==================== JWT 认证配置 ====================
      - key: SECRET_KEY
        generateValue: true

      # ==================== API 密钥配置 ====================
      - key: GEMINI_API_KEY
        sync: false  # Must be set manually in Render dashboard
      - key: GPTZERO_API_KEY
        sync: false  # Must be set manually in Render dashboard

      # ==================== 数据库配置 ====================
      - key: DATABASE_TYPE
        value: postgresql

      # ==================== 管理员配置 ====================
      - key: ADMIN_USERNAME
        value: admin
      - key: ADMIN_PASSWORD
        generateValue: true

      # ==================== CORS 配置 ====================
      - key: CORS_ORIGINS
        value: https://otiumtrans.netlify.app,http://localhost:3000

      # ==================== 安全配置 ====================
      - key: ENABLE_HTTPS_REDIRECT
        value: true

      # ==================== 日志配置 ====================
      - key: LOG_LEVEL
        value: INFO
      - key: LOG_TO_CONSOLE
        value: true

      # ==================== 邮件服务配置 ====================
      - key: SMTP_HOST
        value: smtp.sendgrid.net
      - key: SMTP_PORT
        value: "587"
      - key: SMTP_USERNAME
        value: apikey
      - key: SMTP_PASSWORD
        sync: false  # Must be set manually in Render dashboard
      - key: SMTP_FROM
        value: noreply@example.com
      - key: SMTP_TLS
        value: "true"
      - key: SMTP_SSL
        value: "false"
      - key: VERIFICATION_CODE_TTL
        value: "600"
      - key: RESET_TOKEN_TTL
        value: "86400"
      - key: MAX_VERIFICATION_ATTEMPTS
        value: "3"
      - key: EMAIL_VERIFICATION_REQUIRED
        value: "true"
      - key: FRONTEND_BASE_URL
        value: https://otiumtrans.netlify.app

  # PostgreSQL Database
  - type: postgres
    name: otium-database
    region: oregon
    postgresMajorVersion: "16"
    databaseName: otium
    user: otium_admin

# ============================================
# Environment Groups (Shared Variables)
# ============================================

envVarGroups:
  - name: production
    envVars:
      - key: ENVIRONMENT
        value: production
      - key: DEBUG
        value: false
      - key: LOG_LEVEL
        value: INFO
      - key: DATABASE_TYPE
        value: postgresql

# ============================================
# Deploy Hooks
# ============================================

# Pre-deploy script to run database migrations
preDeployScript: |
  #!/bin/bash
  echo "=== Pre-deploy script ==="
  echo "Current directory: $(pwd)"
  echo "Directory structure:"
  ls -la
  echo "Backend directory:"
  ls -la backend/
  echo "Python path:"
  python -c "import sys; print('\\n'.join(sys.path))"
  echo "Running database migrations..."
  cd backend
  # Run Alembic migrations
  echo "Running: alembic upgrade head"
  alembic upgrade head
  echo "Database migrations completed successfully"

# ============================================
# Notes:
# ============================================
# 1. After deploying, you need to manually set:
#    - GEMINI_API_KEY: Your Google Gemini API key
#    - GPTZERO_API_KEY: Your GPTZero API key
#    - SECRET_KEY: If you want a specific value (otherwise auto-generated)
#    - ADMIN_PASSWORD: If you want a specific password (otherwise auto-generated)
#
# 2. Update CORS_ORIGINS with your actual Netlify frontend URL
#
# 3. For production, consider upgrading the database plan
#
# 4. Monitor logs in Render Dashboard -> otium-backend -> Logs