# Render Blueprint for Otium Application
# This file defines the infrastructure for the Otium backend and database

# ============================================
# Services Configuration
# ============================================

services:
  # Otium Backend API Service
  - type: web
    name: otium-backend
    env: python
    pythonVersion: "3.11.9"
    region: oregon  # or: frankfurt, singapore, ohio, etc.
    buildCommand: pip install -r backend/requirements.txt
    startCommand: cd backend && gunicorn --bind 0.0.0.0:$PORT --workers 4 --worker-class uvicorn.workers.UvicornWorker --timeout 120 main:app
    healthCheckPath: /api/health
    envVars:
      # ==================== 应用配置 ====================
      - key: ENVIRONMENT
        value: production
      - key: DEBUG
        value: false

      # ==================== Render 自动配置 ====================
      - key: RENDER
        value: true
      - fromService:
          type: postgres
          name: otium-database
          property: connectionString

      # ==================== JWT 认证配置 ====================
      - key: SECRET_KEY
        generateValue: true

      # ==================== API 密钥配置 ====================
      - key: GEMINI_API_KEY
        sync: false  # Must be set manually in Render dashboard
      - key: GPTZERO_API_KEY
        sync: false  # Must be set manually in Render dashboard

      # ==================== 数据库配置 ====================
      - key: DATABASE_TYPE
        value: postgresql

      # ==================== 用户限制配置 ====================
      - key: DAILY_TRANSLATION_LIMIT
        value: "3"
      - key: DAILY_AI_DETECTION_LIMIT
        value: "3"

      # ==================== 管理员配置 ====================
      - key: ADMIN_USERNAME
        value: admin
      - key: ADMIN_PASSWORD
        generateValue: true

      # ==================== CORS 配置 ====================
      - key: CORS_ORIGINS
        value: https://otiumtrans.netlify.app,http://localhost:3000

      # ==================== 安全配置 ====================
      - key: ENABLE_HTTPS_REDIRECT
        value: true

      # ==================== 日志配置 ====================
      - key: LOG_LEVEL
        value: INFO
      - key: LOG_TO_CONSOLE
        value: true

      # ==================== 邮件服务配置 ====================
      # 注意：请手动在 Render Dashboard 中设置以下环境变量：
      # RESEND_API_KEY: 您的 Resend API 密钥
      # RESEND_FROM: 发件人邮箱（已验证的邮箱）
      - key: VERIFICATION_CODE_TTL
        value: "600"
      - key: RESET_TOKEN_TTL
        value: "86400"
      - key: MAX_VERIFICATION_ATTEMPTS
        value: "3"
      - key: EMAIL_VERIFICATION_REQUIRED
        value: "true"
      - key: FRONTEND_BASE_URL
        value: https://otiumtrans.netlify.app

  # PostgreSQL Database
  - type: postgres
    name: otium-database
    region: oregon
    postgresMajorVersion: "16"
    databaseName: otium
    user: otium_admin

# ============================================
# Environment Groups (Shared Variables)
# ============================================

envVarGroups:
  - name: production
    envVars:
      - key: ENVIRONMENT
        value: production
      - key: DEBUG
        value: false
      - key: LOG_LEVEL
        value: INFO
      - key: DATABASE_TYPE
        value: postgresql

# ============================================
# Deploy Hooks
# ============================================

# Pre-deploy script to run database migrations
preDeployScript: |
  #!/bin/bash
  set -e
  set -o pipefail
  echo "=== Pre-deploy script ==="
  echo "Current directory: $(pwd)"
  echo "Directory structure:"
  ls -la
  echo "Backend directory:"
  ls -la backend/

  # 检查Python环境
  echo "=== Python环境检查 ==="
  python --version
  python -c "import sys; print('Python路径:', sys.executable)"
  python -c "import sys; print('系统路径:'); print('\\n'.join(sys.path))"

  # 检查Alembic安装
  echo "=== Alembic检查 ==="
  python -c "import alembic; print(f'Alembic版本: {alembic.__version__}')" || echo "警告: Alembic导入失败"

  # 检查alembic.ini文件
  echo "=== 迁移文件检查 ==="
  if [ -f "backend/alembic.ini" ]; then
    echo "alembic.ini文件存在"
    ls -la backend/alembic.ini
  else
    echo "错误: alembic.ini文件不存在!"
    exit 1
  fi

  # 检查migrations目录
  if [ -d "backend/migrations" ]; then
    echo "migrations目录存在"
    ls -la backend/migrations/
    if [ -d "backend/migrations/versions" ]; then
      echo "versions目录存在"
      ls -la backend/migrations/versions/
    else
      echo "警告: versions目录不存在"
    fi
  else
    echo "错误: migrations目录不存在!"
    exit 1
  fi

  # 运行数据库迁移
  echo "=== 运行数据库迁移 ==="
  cd backend

  # 检查当前迁移状态
  echo "检查当前迁移状态:"
  alembic current || echo "无法获取当前迁移状态，继续执行..."

  # 检查可用迁移
  echo "检查可用迁移:"
  alembic history || echo "无法获取迁移历史，继续执行..."

  # 运行迁移
  echo "运行迁移: alembic upgrade head"
  if alembic upgrade head; then
    echo "数据库迁移成功完成"
  else
    echo "错误: 数据库迁移失败!"
    echo "尝试降级后再升级..."
    alembic downgrade -1 || echo "降级失败，继续..."
    alembic upgrade head || echo "升级失败，应用将继续启动但可能有限制"
  fi

  # 验证users表结构
  echo "=== 验证数据库表结构 ==="
  python -c "
import os
import sys
sys.path.insert(0, '.')
from sqlalchemy import inspect, create_engine
from models.database import get_database_url

try:
    print('获取数据库URL...')
    db_url = get_database_url()
    print(f'数据库URL: {db_url[:50]}...' if len(db_url) > 50 else f'数据库URL: {db_url}')

    engine = create_engine(db_url)
    inspector = inspect(engine)

    print('数据库中的表:')
    tables = inspector.get_table_names()
    for table in tables:
        print(f'  - {table}')

    if 'users' in tables:
        print('users表存在，检查列:')
        columns = inspector.get_columns('users')
        for col in columns:
            print(f'  - {col[\"name\"]}: {col[\"type\"]}')

        # 检查email列
        column_names = [col['name'] for col in columns]
        if 'email' in column_names:
            print('✅ users表已包含email列')
        else:
            print('❌ users表缺少email列')
    else:
        print('❌ users表不存在')

except Exception as e:
    print(f'验证数据库时出错: {e}')
    import traceback
    traceback.print_exc()
  "

  echo "预部署脚本完成"

# ============================================
# Notes:
# ============================================
# 1. After deploying, you need to manually set:
#    - GEMINI_API_KEY: Your Google Gemini API key
#    - GPTZERO_API_KEY: Your GPTZero API key
#    - SECRET_KEY: If you want a specific value (otherwise auto-generated)
#    - ADMIN_PASSWORD: If you want a specific password (otherwise auto-generated)
#
# 2. Update CORS_ORIGINS with your actual Netlify frontend URL
#
# 3. For production, consider upgrading the database plan
#
# 4. Monitor logs in Render Dashboard -> otium-backend -> Logs