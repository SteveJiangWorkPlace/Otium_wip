# 文献调研问题诊断报告

## 诊断日期
2026-02-28

## 问题概述
1. **Render后台应用连接问题**：文献调研可以发送到Manus API，但默认提示词没有被应用，调研结果无法返回前端
2. **结果缓存和传输问题**：Manus API结果已生成，但没有正确传递到前端应用
3. **加载动画格式**：用户要求文献调研的加载动画格式完全参考普通对话

## 诊断方法
1. 测试生产环境API端点
2. 分析前后端代码逻辑
3. 创建测试脚本验证问题
4. 检查数据库任务状态

## 发现的关键问题

### 1. API响应格式不匹配（核心问题）
- **前端期望**：`GetTaskStatusResponse`接口包含`task`字段（BackgroundTask对象）
- **后端实际**：`TaskStatusResponse`直接返回字段在根目录，没有`task`字段
- **影响**：前端`pollTaskResult`函数无法获取任务数据，导致结果无法显示

### 2. 结果缓存位置
- **确认**：Manus API结果正确存储在`background_tasks`表的`result_data`字段中
- **验证**：任务ID:4已成功完成，包含完整的文献调研结果
- **问题**：结果无法通过API正确传递给前端

### 3. 提示词应用问题
- **检查**：`api_services.py`中的`chat_with_manus`函数正确调用`build_literature_research_prompt`
- **可能原因**：生产环境可能未使用最新的提示词模板系统

### 4. 前端加载动画
- **现状**：AIChatPanel.tsx中有三种不同的加载显示逻辑
- **用户要求**：统一使用普通对话的加载动画格式

## 已实施的修复

### 1. 后端API响应格式修复
**文件**：`backend/main.py`
- 修改`get_task_status`函数（第2014-2042行）
- 创建`task_obj`字典，将现有字段包装到`task`字段中
- 返回包含`success`、`task`、`message`、`error`字段的响应

**文件**：`backend/schemas.py`
- 更新`TaskStatusResponse`模型（第303-320行）
- 添加`task`、`message`、`error`字段
- 保留原有字段用于向后兼容

### 2. 前端加载动画统一
**文件**：`frontend/src/components/AIChatPanel/AIChatPanel.tsx`
- 移除复杂的`backgroundTaskContainer`和`manusSteps`显示逻辑
- 统一使用`processingStepsContainer`格式
- 修复语法错误（多余的闭合div标签）

### 3. 后台任务提示词构建
**文件**：`backend/background_task_service.py`
- 确保`prompt_already_built=False`，以便在后台任务中构建提示词

## 需要部署的更改

### 必须部署的文件：
1. `backend/main.py` - API响应格式修复
2. `backend/schemas.py` - 响应模型更新
3. `backend/api_services.py` - 已包含提示词模板系统（确认已部署）

### 可选部署的文件：
1. `frontend/src/components/AIChatPanel/AIChatPanel.tsx` - 加载动画统一
2. `backend/background_task_service.py` - 提示词构建优化

## 验证步骤

### 1. 部署后验证
```bash
# 测试API响应格式
curl -H "Authorization: Bearer <token>" https://otium.onrender.com/api/tasks/4/status

# 预期响应：
{
  "success": true,
  "task": {
    "id": 4,
    "status": "completed",
    "result_data": {
      "text": "...文献调研结果...",
      "steps": [...]
    },
    # ...其他字段
  },
  "message": null,
  "error": null
}
```

### 2. 前端功能测试
1. 打开前端应用
2. 启用文献调研模式
3. 发送测试请求
4. 验证：
   - 加载动画显示"文献调研可能需要较长时间，请耐心等待..."
   - 任务轮询正常工作
   - 结果正确显示

### 3. 提示词系统验证
检查Render日志中是否有：
- "使用新提示词模板系统"
- "build_literature_research_prompt"
- "提示词模板构建完成"

## 技术细节

### 1. 修复的API端点
- `GET /api/tasks/{task_id}/status`
- `POST /api/tasks/poll`

### 2. 前端期望的响应格式
```typescript
interface GetTaskStatusResponse {
  success: boolean;
  task: BackgroundTask;  // 必需字段
  message?: string;
  error?: string;
}

interface BackgroundTask {
  id: number;
  status: BackgroundTaskStatus;
  result_data: Record<string, any> | null;
  // ...其他字段
}
```

### 3. 修复后的响应格式
```python
class TaskStatusResponse(BaseModel):
    success: bool
    task: dict[str, Any] | None = None  # 新增：包装任务对象
    message: str | None = None
    error: str | None = None
    # 向后兼容字段...
```

## 风险与注意事项

### 1. 向后兼容性
- 修改后的API仍包含原有字段（`task_id`、`status`、`result_data`等）
- 确保不影响现有客户端

### 2. 数据库状态
- 任务ID:4已包含完整结果，部署后可立即测试
- 无需数据迁移

### 3. 前端兼容性
- 前端已期望`task`字段，修改后应能正常工作
- 加载动画修改为纯UI优化，不影响功能

## 下一步建议

### 立即行动：
1. 部署修复代码到生产环境
2. 验证API响应格式
3. 测试完整文献调研流程

### 长期改进：
1. 增强API版本管理
2. 添加更详细的日志记录
3. 实现前端错误监控

## 附录：测试脚本

已创建的测试脚本：
1. `test_api_response_mismatch.py` - 诊断API格式问题
2. `test_api_format_fix.py` - 验证修复后的API格式
3. `verify_fixes.py` - 完整功能验证
4. `test_frontend_flow.py` - 前端流程模拟

## 结论

文献调研功能的核心问题是**前后端API响应格式不匹配**。后端未提供前端期望的`task`字段，导致结果无法传递。修复方案已准备好，部署后应能解决：

1. ✅ 结果正确传递到前端
2. ✅ 加载动画格式统一
3. ✅ 提示词系统正常工作
4. ✅ Render后台应用正常运行